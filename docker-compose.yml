# Docker Compose for Inventory Service with Kafka Infrastructure
# This runs: Zookeeper, Kafka, Kafka UI, MySQL, and Inventory Service
# Other services run locally in IntelliJ and connect via localhost

services:
  # Zookeeper - Required for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - inventory-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka - Message broker for order-inventory communication
  # Configured to be accessible from localhost (for local services) and Docker network
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Accessible from localhost (for local services) and Docker network
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - inventory-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka UI - Web interface to monitor Kafka topics and messages
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8089:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9093
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    networks:
      - inventory-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MySQL Database for Inventory Service
  # Using port 3307 to avoid conflict with local MySQL on 3306
  mysql-inventory:
    image: mysql:8.0
    container_name: mysql-inventory
    environment:
      MYSQL_ROOT_PASSWORD: admin
      MYSQL_DATABASE: inventory
      MYSQL_USER: inventory_user
      MYSQL_PASSWORD: admin
    ports:
      - "3307:3306"  # External port 3307 maps to internal 3306
    volumes:
      - mysql-inventory-data:/var/lib/mysql
    networks:
      - inventory-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-padmin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Inventory Service
  inventory-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inventory-service
    depends_on:
      mysql-inventory:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8085:8085"
    environment:
      # Server Configuration
      SERVER_PORT: 8085
      
      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-inventory:3306/inventory?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: admin
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: com.mysql.cj.jdbc.Driver
      
      # Kafka Configuration
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9093
      KAFKA_BOOTSTRAP_SERVERS: kafka:9093
      SPRING_KAFKA_PRODUCER_KEY_SERIALIZER: org.apache.kafka.common.serialization.StringSerializer
      SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER: org.springframework.kafka.support.serializer.JsonSerializer
      SPRING_KAFKA_CONSUMER_BOOTSTRAP_SERVERS: kafka:9093
      SPRING_KAFKA_CONSUMER_GROUP_ID: inventory-service-group
      SPRING_KAFKA_CONSUMER_KEY_DESERIALIZER: org.apache.kafka.common.serialization.StringDeserializer
      SPRING_KAFKA_CONSUMER_VALUE_DESERIALIZER: org.springframework.kafka.support.serializer.JsonDeserializer
      SPRING_KAFKA_CONSUMER_PROPERTIES_SPRING_JSON_TRUSTED_PACKAGES: "*"
      
      # Topic Names
      KAFKA_TOPIC_ORDERS_EVENTS: orders-events
      KAFKA_TOPIC_INVENTORY_EVENTS: inventory-events
      
      # JPA Configuration
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_OPEN_IN_VIEW: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.MySQLDialect
      
      # Eureka Configuration (connects to local Eureka running in IntelliJ)
      # Use host.docker.internal to access localhost from Docker container
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://host.docker.internal:8761/eureka/
      # Register with localhost so API Gateway can route to it
      EUREKA_INSTANCE_HOSTNAME: localhost
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: false
      # Override application.yaml settings
      SPRING_CLOUD_CONFIG_ENABLED: "false"
      
      # Security
      SPRING_SECURITY_USER_NAME: admin
      SPRING_SECURITY_USER_PASSWORD: admin123
      AUTHORIZATION_JWT_SECRET: MySuperSecretKeyChangeThisKeyThatHasAtLeast32Chars
      AUTHORIZATION_JWT_EXPIRATION_DAYS: 7
    extra_hosts:
      # For Linux compatibility - allows Docker container to access host machine
      - "host.docker.internal:host-gateway"
    networks:
      - inventory-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

volumes:
  mysql-inventory-data:
    driver: local

networks:
  inventory-network:
    driver: bridge

